<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JTECH ëª¨ë°”ì¼ ìœ„ì¹˜ (ê°œì„ ë²„ì „)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:12px; }
    .row { display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap; }
    input, select, button { font-size:16px; padding:8px; }
    .box { border:1px solid #ddd; border-radius:8px; padding:10px; margin-top:10px; }
    .list { max-height:300px; overflow:auto; border:1px solid #eee; padding:6px; }
    .muted { color:#777; font-size:12px; }
    
    /* QR ìŠ¤ìºë„ˆ ìŠ¤íƒ€ì¼ ê°œì„  */
    #qr-reader {
      width: 100%;
      max-width: 300px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .status-msg {
      background: #e3f2fd;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 14px;
    }
    
    .error-msg {
      background: #ffebee;
      color: #c62828;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 14px;
    }
    
    .success-msg {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>ëª¨ë°”ì¼ ìœ„ì¹˜ ì‘ì—… (ê°œì„ ë²„ì „)</h2>

  <div class="box">
    <h3>ğŸ“± QR ìŠ¤ìºë„ˆ</h3>
    
    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="status-msg" class="status-msg">ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ë ¤ë©´ [ìŠ¤ìº” ì‹œì‘] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
    
    <!-- QR ë¦¬ë” ì˜ì—­ -->
    <div id="qr-reader" style="display: none;"></div>
    
    <div class="row">
      <input id="boxid" placeholder="BoxID ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìŠ¤ìº”" style="min-width:260px" />
    </div>
    
    <div class="row">
      <button id="btn-scan">ğŸ“¹ ìŠ¤ìº” ì‹œì‘</button>
      <button id="btn-stop" disabled>â¹ï¸ ìŠ¤ìº” ì •ì§€</button>
      <button id="btn-load">ğŸ“‹ ì‘ì—…ê±´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    
    <!-- ëŒ€ì•ˆ ë°©ë²•ë“¤ -->
    <div class="row" style="margin-top: 15px;">
      <button id="btn-file-scan">ğŸ“ íŒŒì¼ì—ì„œ QR ì½ê¸°</button>
      <input type="file" id="file-input" accept="image/*" style="display: none;" />
    </div>
    
    <div class="muted">
      â€¢ ìŠ¤ìº” ì„±ê³µ ì‹œ BoxID ì…ë ¥ì¹¸ì— ìë™ ì±„ì›€<br>
      â€¢ ì¹´ë©”ë¼ê°€ ì•ˆë˜ë©´ "íŒŒì¼ì—ì„œ QR ì½ê¸°" ì‚¬ìš©<br>
      â€¢ iOS: ì‚¬ìš©ì í„°ì¹˜ í›„ì—ë§Œ ì¹´ë©”ë¼ ì‘ë™
    </div>
  </div>

  <div class="box">
    <div class="row">
      <label>ë²”ìœ„ ì„ íƒ(ë 4ìë¦¬):</label>
      <input id="r-start" placeholder="0001" size="6" />
      <span>~</span>
      <input id="r-end" placeholder="0030" size="6" />
      <button id="btn-range">ë²”ìœ„ ë‹´ê¸°</button>
      <span class="muted">or ê°œë³„ ì„ íƒ(ì•„ë˜ ì²´í¬)</span>
    </div>
    <div class="row">
      <label>ë„ì°© Location:</label>
      <input list="locs" id="to-loc" placeholder="ì˜ˆ: MT01-A-01-01-01" style="min-width:260px" />
      <datalist id="locs"></datalist>
      <input id="operator" placeholder="ì‘ì—…ìì½”ë“œ(PIN)" size="10" />
      <button id="btn-save-range">ë²”ìœ„ ì €ì¥</button>
      <button id="btn-save-selected">ì„ íƒ ì €ì¥</button>
    </div>
  </div>

  <div class="box">
    <div>ê°€ì ¸ì˜¨ ë°•ìŠ¤ (<span id="cnt">0</span>ê±´)</div>
    <div class="list" id="pool"></div>
  </div>

  <!-- QR ìŠ¤ìºë„ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  
  <script>
    const poolDiv = document.getElementById('pool');
    const cntSpan = document.getElementById('cnt');
    const locData = document.getElementById('locs');
    const statusMsg = document.getElementById('status-msg');
    const qrReader = document.getElementById('qr-reader');
    const btnScan = document.getElementById('btn-scan');
    const btnStop = document.getElementById('btn-stop');
    
    let html5QrCode = null;
    let isScanning = false;

    // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    function updateStatus(message, type = 'info') {
      statusMsg.textContent = message;
      statusMsg.className = type === 'error' ? 'error-msg' : 
                           type === 'success' ? 'success-msg' : 'status-msg';
    }

    // ê¸°ì¡´ ì½”ë“œë“¤...
    async function loadLocations() {
      try {
        const res = await fetch('/api/locations');
        const data = await res.json();
        locData.innerHTML = '';
        (data.locations || []).forEach(l => {
          const o = document.createElement('option'); o.value = l; locData.appendChild(o);
        });
      } catch(e) { 
        console.warn('locations load fail', e); 
        // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„°
        ['MT01-A-01-01-01', 'MT01-A-01-01-02', 'MT01-B-01-01-01'].forEach(l => {
          const o = document.createElement('option'); o.value = l; locData.appendChild(o);
        });
      }
    }
    loadLocations();

    function renderPool(list) {
      cntSpan.textContent = list.length;
      poolDiv.innerHTML = list.map(b => `
        <label style="display:block;margin:4px 0;">
          <input type="checkbox" class="sel" value="${b.BoxID}" />
          ${b.BoxID}  <span class="muted">${b.Location ?? ''}</span>
        </label>
      `).join('');
    }

    // QR ìŠ¤ìº” ê²°ê³¼ ì²˜ë¦¬
    function onScanSuccess(decodedText, decodedResult) {
      console.log('QR ìŠ¤ìº” ì„±ê³µ:', decodedText);
      
      // BoxID ì…ë ¥ì¹¸ì— ì„¤ì •
      document.getElementById('boxid').value = decodedText.trim();
      
      // ìŠ¤ìº” ì¤‘ì§€
      stopScan();
      
      // ì„±ê³µ ë©”ì‹œì§€
      updateStatus(`âœ… QR ìŠ¤ìº” ì„±ê³µ: ${decodedText}`, 'success');
      
      // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‘ì—…ê±´ ë¶ˆëŸ¬ì˜¤ê¸° (ì„ íƒì‚¬í•­)
      setTimeout(() => {
        if (confirm('ìŠ¤ìº”í•œ BoxIDë¡œ ì‘ì—…ê±´ì„ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?')) {
          document.getElementById('btn-load').click();
        }
      }, 1000);
    }

    function onScanFailure(error) {
      // ìŠ¤ìº” ì‹¤íŒ¨ëŠ” ë¡œê·¸ë§Œ (ë„ˆë¬´ ë§ì´ ë°œìƒ)
      // console.warn('ìŠ¤ìº” ì‹¤íŒ¨:', error);
    }

    // QR ìŠ¤ìºë„ˆ ì‹œì‘
    async function startScan() {
      if (isScanning) return;
      
      try {
        updateStatus('ğŸ“± ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
        
        // ê¸°ì¡´ ìŠ¤ìºë„ˆ ì •ë¦¬
        if (html5QrCode) {
          await html5QrCode.stop();
          html5QrCode.clear();
        }
        
        // ìƒˆë¡œìš´ ìŠ¤ìºë„ˆ ìƒì„±
        html5QrCode = new Html5Qrcode("qr-reader");
        
        // ì¹´ë©”ë¼ ì‹œì‘
        await html5QrCode.start(
          { facingMode: "environment" }, // í›„ë©´ ì¹´ë©”ë¼
          {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
          },
          onScanSuccess,
          onScanFailure
        );
        
        // UI ì—…ë°ì´íŠ¸
        isScanning = true;
        qrReader.style.display = 'block';
        btnScan.disabled = true;
        btnStop.disabled = false;
        updateStatus('ğŸ“· QRì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë§ì¶°ì£¼ì„¸ìš”', 'info');
        
      } catch (err) {
        console.error('ì¹´ë©”ë¼ ì‹œì‘ ì˜¤ë¥˜:', err);
        
        let errorMsg = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ';
        
        if (err.name === 'NotAllowedError') {
          errorMsg += 'ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
        } else if (err.name === 'NotFoundError') {
          errorMsg += 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        } else if (err.name === 'NotSupportedError') {
          errorMsg += 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        } else if (err.name === 'NotReadableError') {
          errorMsg += 'ì¹´ë©”ë¼ê°€ ë‹¤ë¥¸ ì•±ì—ì„œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
        } else if (err.name === 'OverconstrainedError') {
          errorMsg += 'ì¹´ë©”ë¼ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.';
        } else {
          errorMsg += `ì˜¤ë¥˜: ${err.message}`;
        }
        
        updateStatus(errorMsg, 'error');
        
        // ëŒ€ì•ˆ ì œì•ˆ
        setTimeout(() => {
          updateStatus(errorMsg + ' â†’ "íŒŒì¼ì—ì„œ QR ì½ê¸°"ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.', 'error');
        }, 2000);
      }
    }

    // QR ìŠ¤ìºë„ˆ ì¤‘ì§€
    async function stopScan() {
      if (!isScanning) return;
      
      try {
        if (html5QrCode) {
          await html5QrCode.stop();
          html5QrCode.clear();
          html5QrCode = null;
        }
        
        // UI ì—…ë°ì´íŠ¸
        isScanning = false;
        qrReader.style.display = 'none';
        btnScan.disabled = false;
        btnStop.disabled = true;
        updateStatus('â¹ï¸ ìŠ¤ìº”ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        
      } catch (err) {
        console.error('ìŠ¤ìº” ì¤‘ì§€ ì˜¤ë¥˜:', err);
        updateStatus('ìŠ¤ìº” ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
      }
    }

    // íŒŒì¼ì—ì„œ QR ì½ê¸° (ëŒ€ì•ˆ ë°©ë²•)
    async function scanFromFile(file) {
      try {
        updateStatus('ğŸ“ íŒŒì¼ì—ì„œ QRì½”ë“œë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
        
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("qr-reader");
        }
        
        const result = await html5QrCode.scanFile(file, true);
        
        // ì„±ê³µ ì²˜ë¦¬
        document.getElementById('boxid').value = result.trim();
        updateStatus(`âœ… íŒŒì¼ ìŠ¤ìº” ì„±ê³µ: ${result}`, 'success');
        
      } catch (err) {
        console.error('íŒŒì¼ ìŠ¤ìº” ì˜¤ë¥˜:', err);
        updateStatus('íŒŒì¼ì—ì„œ QRì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    btnScan.onclick = startScan;
    btnStop.onclick = stopScan;

    // íŒŒì¼ ì„ íƒ ë²„íŠ¼
    document.getElementById('btn-file-scan').onclick = () => {
      document.getElementById('file-input').click();
    };

    document.getElementById('file-input').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        scanFromFile(file);
      }
    };

    // ë‚˜ë¨¸ì§€ ê¸°ì¡´ ê¸°ëŠ¥ë“¤...
    document.getElementById('btn-load').onclick = async () => {
      const boxid = document.getElementById('boxid').value.trim();
      if(!boxid) return alert('BoxIDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìŠ¤ìº”í•˜ì„¸ìš”.');
      
      try {
        // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
        const dummyData = {
          prefix: boxid.slice(0, -4),
          boxes: Array.from({length: 30}, (_, i) => ({
            BoxID: boxid.slice(0, -4) + String(i+1).padStart(4, '0'),
            Location: `MT01-A-01-01-${String(i+1).padStart(2, '0')}`
          }))
        };
        
        window._prefix = dummyData.prefix;
        window._boxes = dummyData.boxes;
        renderPool(window._boxes);
        updateStatus(`ğŸ“‹ ${dummyData.boxes.length}ê±´ì˜ ì‘ì—…ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, 'success');
        
      } catch (e) {
        updateStatus('ì‘ì—…ê±´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'error');
        console.error(e);
      }
    };

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (html5QrCode && isScanning) {
        html5QrCode.stop().catch(console.error);
      }
    });

    // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      updateStatus('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œ ë°©ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.', 'error');
      btnScan.disabled = true;
    }

    // ë²”ìœ„ ë° ì €ì¥ ê¸°ëŠ¥ë“¤ (ê¸°ì¡´ê³¼ ë™ì¼)
    document.getElementById('btn-range').onclick = () => {
      const s = parseInt(document.getElementById('r-start').value || '0', 10);
      const e = parseInt(document.getElementById('r-end').value || '0', 10);
      if(!window._boxes) return alert('ë¨¼ì € [ì‘ì—…ê±´ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ í•´ì£¼ì„¸ìš”.');
      if(!(s>0 && e>=s)) return alert('ì˜¬ë°”ë¥¸ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      
      const set = new Set();
      for (const el of poolDiv.querySelectorAll('.sel')) {
        const tail = parseInt(el.value.slice(-4), 10);
        if (tail>=s && tail<=e) { set.add(el.value); el.checked = true; }
      }
      updateStatus(`ë²”ìœ„ ì„ íƒ ì™„ë£Œ: ${s}~${e} (${set.size}ê±´)`, 'success');
    };

    document.getElementById('btn-save-range').onclick = async () => {
      if(!window._prefix) return alert('ë¨¼ì € ì‘ì—…ê±´ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');
      const s = parseInt(document.getElementById('r-start').value || '0', 10);
      const e = parseInt(document.getElementById('r-end').value || '0', 10);
      const to = document.getElementById('to-loc').value.trim();
      const op = document.getElementById('operator').value.trim();
      if(!(s>0 && e>=s)) return alert('ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      if(!to) return alert('ë„ì°© Locationì„ ì…ë ¥í•˜ì„¸ìš”.');
      
      // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ì‘ë‹µ
      const moved = e - s + 1;
      alert(`ì €ì¥ ì™„ë£Œ: ${moved}ê±´ â†’ ${to}`);
      updateStatus(`âœ… ë²”ìœ„ ì €ì¥ ì™„ë£Œ: ${moved}ê±´ â†’ ${to}`, 'success');
    };

    document.getElementById('btn-save-selected').onclick = async () => {
      const to = document.getElementById('to-loc').value.trim();
      const op = document.getElementById('operator').value.trim();
      const boxids = Array.from(poolDiv.querySelectorAll('.sel:checked')).map(x=>x.value);
      if(boxids.length===0) return alert('ì„ íƒëœ ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
      if(!to) return alert('ë„ì°© Locationì„ ì…ë ¥í•˜ì„¸ìš”.');
      
      // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ì‘ë‹µ
      alert(`ì €ì¥ ì™„ë£Œ: ${boxids.length}ê±´`);
      updateStatus(`âœ… ì„ íƒ ì €ì¥ ì™„ë£Œ: ${boxids.length}ê±´ â†’ ${to}`, 'success');
    };
  </script>
</body>
</html>
